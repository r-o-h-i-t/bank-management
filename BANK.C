/*Ideas:
1.Use file and create database of account details*************DONE**********
2.Maintain a database for customer account ID and paswd*******DONE**********
3.Add a option to change master pin***************************DONE**********
4.show star instead of blank while entering pin***************DONE**********
5.Create seprate page for manager login and customer login****DONE**********
6.Add floating point values too till paise********************DONE**********
7.Add Border to the program***********************************DONE**********
8.Add feature to view all accounts from manager side**********DONE**********
9.Restrict duplicate account nos. entry***********************DONE**********
10.Give opt to add cash in bulk*******************************DONE**********
11.At the pt. of deletion show tht user & ask to confirm******DONE**********
12.Feature to store full name*********************************DONE**********
13.Func. for borders******************************************DONE**********
14.Transfer NEFT**********************************************DONE**********
*/
//------------------------- Header Files ---------------------------------
#include<stdio.h>
#include<conio.h>
#include<dos.h>
#include<process.h>
//------------------------- Global Variables -----------------------------
int acc,opt,n;
FILE *f;

//----------------------------- Structure --------------------------------
struct cust
{
	int acc_no;
	char name[35];
	float bal;
	int pin;
}c;

//------------------------- Function Declaration -------------------------
void mangr_login();
void add_acc();
void del_acc(int);
void change_pin();
void view_all();
void cust_login();
void view_acc(int);
void view_bal(int);
void depo_cash(int);
void transfer(int);
void border();

/*----------------------------- Border -----------------------------------*/
void border()
{
	clrscr();
	gotoxy(1,1);
	for(n=0; n<80; n++)
		printf("*");
	gotoxy(1,24);
	for(n=0; n<80; n++)
		printf("*");
}
//----------------------------- Main Function ----------------------------
int main()
{
	border();
	gotoxy(22,4);
	printf("Welcome to Bank Management System\n\n\n");
	gotoxy(25,10);
	printf("Press any key for login page\n");
	gotoxy(18,16);
	printf("By: Rohit Soni  2016ccRohit4762@poornima.edu.in");
	gotoxy(14,19);
	printf("B.Tech CE (Cloud Technology and Information Security)");
	gotoxy(25,21);
	printf("Poornima University, Jaipur");
	gotoxy(80,24);
	getch();
	while(1)
	{
		border();
		gotoxy(30,3);
		printf("LOGIN PAGE");
		gotoxy(20,10);
		printf("1-Manager Login\n\n");
		gotoxy(20,12);
		printf("2-Customer Login\n\n");
		gotoxy(20,14);
		printf("3-Exit\n\n");
		opt=getch()-'0';
		switch(opt)
		{
			case 1:
				mangr_login();
				break;
			case 2:
				cust_login();
				break;
			case 3:
				exit(0);
		}
	}

}

/* ----------------------------- Manager Login --------------------------*/
void mangr_login()
{
	int checkPIN=0 ,origPIN ,i;
	border();
	gotoxy(30,3);
	printf("MANAGER LOGIN PAGE");
	gotoxy(25,10);
	printf("Enter master pin: ");
	for(i=0; i<4; i++)
	{
		checkPIN = (checkPIN*10)+(getch()-'0');
		printf("*");
	}
	f=fopen("pin.bat","r");
	if(f==NULL)
	{
		gotoxy(15,12);
		printf("Database not found! \n Please contact admin.\n");
		getch();
		goto logout;
	}

	origPIN=getw(f);
	fclose(f);

	/* Authentication of PIN */

	if(checkPIN!=origPIN)
	{
		gotoxy(28,12);
		printf("Wrong PIN Entered");
		gotoxy(21,14);
		printf("Program will exit in 3 seconds");
		delay(3000);
		exit(0);
	}
	gotoxy(32,12);
	printf("Success!");
	gotoxy(21,15);
	printf("Main Window Opening in a moment");
	delay(2000);

	while(1)
	{
		border();
		gotoxy(30,3);
		printf("MANAGER ACCOUNT");
		gotoxy(22,9);
		printf("Please choose the following:\n\n\n1-Open an Account\n2-Delete an Account\n3-View all open accounts\n4-Change Master PIN\n5-Logout\n");
		opt=getch()-'0';
		switch(opt)
		{
			case 1:
				add_acc();
				break;
			case 2:
				border();
				gotoxy(30,3);
				printf("MANAGER ACCOUNT");
				gotoxy(23,13);
				printf("Enter Account Number to be deleted: ");
				scanf("%d",&acc);
				if(!((acc>0)&&(acc<32767)))
				{
					border();
					gotoxy(23,16);
					printf("Invalid Account Number");
					gotoxy(23,18);
					printf("->Must be in between 0 to 32767");
					delay(2000);
					goto logout;
				}
				del_acc(acc);
				break;
			case 3:
				view_all();
				break;
			case 4:
				change_pin();
				break;
			case 5:
				goto logout;
			default:
				printf("Wrong Option");
				delay(1000);
		}
	}

	logout:
}

//------------------------- ADD Account -----------------------------
void add_acc()
{
	FILE *f2;
	int temp=0,acc_no,pin;
	float bal;  int i;
	char name[35];
	border();
	gotoxy(30,3);
	printf("MANAGER ACCOUNT");
	f=fopen("record.txt","a");
	f2=fopen("record.txt","r");
	if(f==NULL)
	{
		gotoxy(19,13);
		printf("Database not found! \n Please contact admin.\n");
		getch();
		goto logout;
	}
	gotoxy(19,13);
	printf("Enter account number: ");
	scanf("%d",&c.acc_no);
	if(!((c.acc_no>0)&&(c.acc_no<32767)))
	{
		border();
		gotoxy(19,15);
		printf("Invalid Account Number");
		gotoxy(19,17);
		printf("->Must be in between 0 to 32767");
		delay(2000);
		goto logout;
	}
	gotoxy(19,15);
	printf("Enter name: ");
	gets(c.name);		//accepting enter as a string
	gets(c.name);
	gotoxy(19,17);
	printf("Enter Starting balance: ");
	scanf("%f",&c.bal);
	gotoxy(19,19);
	printf("Enter PIN: ");
	c.pin=0;
	for(n=0; n<4; n++)
	{
		c.pin= (c.pin*10)+(getch()-'0');
		printf("*");
	}
	gotoxy(19,21);
	printf("Re-enter PIN: ");
	for(n=0; n<4; n++)
	{
		temp= (temp*10) + (getch()-'0');
		printf("*");
	}
	if(c.pin!=temp)
	{
		border();
		gotoxy(19,13);
		printf("Incorrect re-entered PIN");
		gotoxy(19,15);
		printf("Press any key to continue");
		getch();
		goto logout;
	}
	else
	{
		while((fscanf(f2,"%d %[^0-9] %f %d",&acc_no, name, &bal, &pin))!=EOF)
			if(c.acc_no==acc_no)
			{
				border();
				gotoxy(19,13);
				printf("Account already exist.");
				gotoxy(15,15);
				printf("Pls enter different account number");
				getch();
				goto logout;
			}

		fprintf(f,"%d %s %2.2f %d",c.acc_no, c.name, c.bal, c.pin);
		fprintf(f,"%c",'\n');
		fclose(f);

		border();
		gotoxy(30,3);
		printf("MANAGER ACCOUNT");
		gotoxy(19,14);
		printf("Successfully Added the account\n");
		getch();
	}
	logout:
}

//---------------------------- Delete Account -----------------------------
void del_acc(int acc)
{
	int flag=0;
	FILE *f2;
	border();
	gotoxy(30,3);
	printf("MANAGER ACCOUNT");
	f=fopen("record.txt","r");
	f2=fopen("temp_record.txt","w");
	if((f==NULL)||(f2==NULL))
	{
		gotoxy(19,13);
		printf("Database not found! \n Please contact admin.\n");
		getch();
		goto logout;
	}

	while((fscanf(f,"%d %[^0-9] %f %d",&c.acc_no, c.name, &c.bal, &c.pin))!=EOF)
	{
		if(acc==c.acc_no)
		{
			flag=1;
			gotoxy(22,9);
			printf("Account no: %d",c.acc_no);
			gotoxy(22,11);
			printf("Name: %s",c.name);
			gotoxy(22,13);
			printf("Balance: %f", c.bal);
			gotoxy(50,11);
			printf("Press 1 to delete\n");
			n=getch()-'0';
			if(n==1)
			{
				gotoxy(24,20);
				printf("Account Deleted");
				delay(2000);
				continue;
			}
		}
		fprintf(f2,"%d %s %f %d %c",c.acc_no, c.name, c.bal, c.pin, '\n');
	}
	if(flag==0)
	{
		gotoxy(23,13);
		printf("Account Not Found");
		delay(2000);
	}
	fclose(f);
	fclose(f2);

	/* Copying records from temp_record.txt to record.txt*/
	f=fopen("record.txt","w");
	f2=fopen("temp_record.txt","r");
	if((f==NULL)||(f2==NULL))
	{
		gotoxy(19,16);
		printf("Database not found! \n Please contact admin.\n");
		getch();
		goto logout;
	}

	while((fscanf(f2,"%d %[^0-9] %f %d",&c.acc_no, &c.name, &c.bal, &c.pin))!=EOF)
		fprintf(f,"%d %s %2.2f %d %c",c.acc_no, c.name, c.bal, c.pin, '\n');
	fclose(f2);
	fclose(f);
	logout:
}

/* ----------------------- View All Accounts -----------------------*/
void view_all()
{
	int i;
	f=fopen("record.txt","r");
	border();
	gotoxy(30,3);
	printf("MANAGER ACCOUNT");
	gotoxy(30,5);
	printf("LIST OF ACCOUNTS");
	i=9;
	gotoxy(5,7);
	printf("Account Number \t Name\t \t \t\t Balance\tPIN");
	while((fscanf(f,"%d %[^0-9] %f %d",&c.acc_no, &c.name, &c.bal, &c.pin))!=EOF)
	{
		gotoxy(5,i);
		printf("\t%d",c.acc_no);
		gotoxy(15,i);
		printf("\t  \t%s",c.name);
		gotoxy(55,i);
		printf("%2.2f",c.bal);
		gotoxy(65,i);
		printf("\t%d",c.pin);
		i+=2;
	}
	getch();
	fclose(f);
}
/*---------------------------Change Master PIN----------------------------   */
void change_pin()
{
	int i, temp=0, checkPIN=0, origPIN;
	border();
	gotoxy(30,3);
	printf("MANAGER ACCOUNT");

	gotoxy(20,10);
	printf("Re-enter your previous pin:");
	for(i=0; i<4; i++)
	{
		checkPIN = (checkPIN*10)+(getch()-'0');
		printf("*");
	}
	f=fopen("pin.bat","r");
	if(f==NULL)
	{
		gotoxy(15,12);
		printf("Database not found! \n Please contact admin.\n");
		getch();
		goto logout;
	}

	origPIN=getw(f);
	fclose(f);
	if(checkPIN==origPIN)
	{
		gotoxy(25,12);
		printf("\nSuccess!");
		gotoxy(23,14);
		printf("Enter your new pin:");
		origPIN=0;
		for(i=0; i<4; i++)
		{
			origPIN = (origPIN*10)+(getch()-'0');
			printf("*");
		}
		gotoxy(23,16);
		printf("Re-enter your new pin:");
		for(i=0; i<4; i++)
		{
			temp = (temp*10)+(getch()-'0');
			printf("*");
		}
		if(temp==origPIN)
		{
			f=fopen("pin.bat","w");
			putw(origPIN,f);
			gotoxy(23,18);
			printf("Successfully changed the PIN\n");
			fclose(f);
		}
		else
		{
			gotoxy(23,18);
			printf("Failure!\n\nWrong pin entered for the second time\n");
		}
	}
	else
	{
		gotoxy(25,12);
		printf("Wrong master password!");
	}
	logout:
}
/* --------------------- Customer Login -------------------------------*/
void cust_login()
{
	int checkPIN=0, checkACC, count=0;
	border();
	gotoxy(30,3);
	printf("CUSTOMER LOGIN PAGE");
	gotoxy(25,10);
	printf("Enter your account number:");
	scanf("%d",&checkACC);
	if(!((checkACC>0)&&(checkACC<32767)))
	{
		border();
		gotoxy(25,12);
		printf("Invalid Account Number");
		gotoxy(25,14);
		printf("->Must be in between 0 to 32767");
		delay(2000);
		goto logout;
	}
	gotoxy(25,12);
	printf("Enter your PIN");
	for(n=0; n<4; n++)
	{
		checkPIN=(checkPIN*10)+(getch()-'0');
		printf("*");
	}
	//Load database to authenticate login info
	f=fopen("record.txt","r");
	if(f==NULL)
	{
		getch();
		gotoxy(25,14);
		printf("Unable to load database");
		gotoxy(25,16);
		printf("Contact admin!");
		getch();
		exit(0);
	}
	while((fscanf(f,"%d %[^0-9] %f %d",&c.acc_no, &c.name, &c.bal, &c.pin))!=EOF)
	{
		if((checkACC==c.acc_no)&&(checkPIN==c.pin))
		{
			count=1;
			gotoxy(25,14);
			printf("Success!");
			gotoxy(20,16);
			printf("Main page opening in a moment");
			delay(2000);
			while(1)
			{
				border();
				// Customer Account Menu
				gotoxy(30,3);
				printf("CUSTOMER ACCOUNT");
				gotoxy(2,7);
				printf("Hello %s",c.name);
				gotoxy(22,9);
				printf("Enter Choice:\n\n1-View Balance\n2-View Account Deatils\n3-Deposit Cash\n4-Transfer Money\n5-Logout\n");
				opt=getch()-'0';
				switch(opt)
				{
					case 1:
						border();
						gotoxy(30,3);
						printf("CUSTOMER ACCOUNT");
						view_bal(checkACC);
						break;
					case 2:
						border();
						gotoxy(30,3);
						printf("CUSTOMER ACCOUNT");
						gotoxy(23,13);
						view_acc(checkACC);
						break;
					case 3:
						border();
						gotoxy(30,3);
						printf("CUSTOMER ACCOUNT");
						gotoxy(23,13);
						depo_cash(checkACC);
						break;
					case 4:
						border();
						gotoxy(30,3);
						printf("CUSTOMER ACCOUNT");
						gotoxy(23,13);
						transfer(checkACC);
						break;
					case 5:
						goto logout;
					default:
						printf("\nWrong Option");
						delay(1000);
				}
			}
		}
	}
	if(count==0)
	{
		border();
		gotoxy(25,14);
		printf("Invalid Account number and PIN combination");
		gotoxy(25,16);
		printf("Press any key to continue");
		getch();
	}
	fclose(f);
	logout:
}


//----------------------------- View Balance ------------------------------
void view_bal(int acc)
{
	int flag=0;
	f=fopen("record.txt","r");
	if(f==NULL)
	{
		gotoxy(19,13);
		printf("Database not found! \n Please contact admin.\n");
		getch();
		goto logout;
	}
	border();
	gotoxy(30,3);
	printf("CUSTOMER ACCOUNT");
	while((fscanf(f,"%d %[^0-9] %f %d",&c.acc_no, &c.name, &c.bal, &c.pin))!=EOF)
		if(c.acc_no==acc)
		{
			flag=1;
			gotoxy(23,13);
			printf("Your total balance is %2.2f.",c.bal);
			getch();
			break;
		}
	if(flag==0)
	{
		gotoxy(23,13);
		printf("Account not found\n");
		delay(1000);
	}
	fclose(f);
	logout:
}

//----------------------------- View Account -------------------------------
void view_acc(int acc_no)
{
	int flag=0;
	border();
	gotoxy(30,3);
	printf("CUSTOMER ACCOUNT");
	f=fopen("record.txt","r");
	if(f==NULL)
	{
		gotoxy(19,13);
		printf("Database not found! \n Please contact admin.\n");
		getch();
		goto logout;
	}
	while((fscanf(f,"%d %[^0-9] %f %d",&c.acc_no, &c.name, &c.bal, &c.pin))!=EOF)
	{
		if(acc_no==c.acc_no)
		{
			flag=1;
			gotoxy(20,8);
			printf("Account Number: %d",c.acc_no);
			gotoxy(20,10);
			printf("Name: %s",c.name);
			gotoxy(20,12);
			printf("Balance: %2.2f",c.bal);
			getch();
			break;
		}
	}
	if(flag==0)
	{
		gotoxy(23,13);
		printf("Account number not found");
		delay(1000);
	}
	fclose(f);
	logout:
}

//----------------------------- Deposit Cash ----------------------------
void depo_cash(int acc)
{
	FILE *f2;
	int count=0;
	border();
	gotoxy(30,3);
	printf("CUSTOMER ACCOUNT");
	f=fopen("record.txt","r");
	f2=fopen("temp_record.txt","w");
	if((f==NULL)||(f2==NULL))
	{
		gotoxy(19,13);
		printf("Database not found! \n Please contact admin.\n");
		getch();
		goto logout;
	}

	while((fscanf(f,"%d %[^0-9] %f %d",&c.acc_no, &c.name, &c.bal, &c.pin))!=EOF)
	{
		if(c.acc_no!=acc)
		{
			gotoxy(23,13);
			fprintf(f2,"%d %s %2.2f %d %c", c.acc_no, c.name, c.bal,c.pin, '\n');
		}
		else
		{
			float sum=0;
			int opt, denom,amt=0;
			count=1;
			repeat:
			border();
			gotoxy(28,8);
			gotoxy(30,3);
			printf("CUSTOMER ACCOUNT");
			gotoxy(22,7);
			printf("Which method you want to deposit cash?\n1-Note by Note\n2-Bulk Cash\n3-Exit");
			n=getch()-'0';

			switch(n)
			{
			/* Select note by note amount */
				case 1:
					do
					{
						border();
						gotoxy(22,7);
						printf("Select your note denomination:\n\n\n\t1-Rs.50\n\t2-Rs.100\n\t3-Rs.500\n\t4-Rs.2000\n");
						scanf("%d",&denom);
						switch (denom)
						{
							case 1:
								amt=50;
								break;
							case 2:
								amt=100;
								break;
							case 3:
								amt=500;
								break;
							case 4:
								amt=2000;
								break;
							default:
								border();
								gotoxy(28,8);
								printf("\nPls Enter correct denomination\n");
						}
						sum=sum+amt;
						printf("\n\nDo you want to enter more notes?\n\n1-YES\n2-NO\n");
						opt=getch()-'0';
					}while(opt!=2);
					break;
				/*Cash in bulk*/
				case 2:
					border();
					gotoxy(22,7);
					printf("Enter total amount to be deposited: ");
					scanf("%f",&sum);
					break;
				case 3:
					goto logout;
				default:
					printf("Wrong Option");
					delay(1000);
					goto repeat;
			}
			border();
			gotoxy(30,3);
			printf("CUSTOMER ACCOUNT");
			gotoxy(25,11);
			printf("Total amount deposited is : %2.2f\n",sum);
			delay(2000);
			c.bal=c.bal+sum;
			fprintf(f2,"%d %s %2.2f %d %c",c.acc_no, c.name, c.bal, c.pin, '\n');
			if(count==0)
			{
				gotoxy(28,12);
				printf("Account not found.");
				delay(1500);
			}

			fclose(f);
			fclose(f2);

			f=fopen("record.txt","w");
			f2=fopen("temp_record.txt","r");

			if((f==NULL)||(f2==NULL))
			{
				gotoxy(19,13);
				printf("Database not found! \n Please contact admin.\n");
				getch();
				goto logout;
			}

			/*Copy temp_record.txt to record.txt */
			while((fscanf(f2,"%d %[^0-9] %f %d",&c.acc_no, &c.name, &c.bal, &c.pin))!=EOF)
				fprintf(f,"%d %s %2.2f %d %c",c.acc_no, c.name, c.bal, c.pin, '\n');
			fclose(f);
			fclose(f2);
		}
	}
	logout:
}
//------------------------------- Transfer Money ----------------------------
void transfer(sAcc)
{
	int rAcc, flag=0;
	float amt,sBal;
	FILE *f2;
	border();
	f=fopen("record.txt","r");
	f2=fopen("temp_record.txt","w");
	if((f==NULL)||(f2==NULL))
	{
		border();
		gotoxy(19,13);
		printf("Database not found.");
		getch();
		goto logout;
	}
	gotoxy(19,6);
	printf("Enter account number to transfer money: ");
	scanf("%d",&rAcc);
	while((fscanf(f,"%d %[^0-9] %f %d",&c.acc_no, c.name, &c.bal, &c.pin))!=EOF)
	{
		if(sAcc==c.acc_no)
		{
			sBal=c.bal;
		}
	}
	fclose(f);
	f=fopen("record.txt","r");
	while((fscanf(f,"%d %[^0-9] %f %d",&c.acc_no, c.name, &c.bal, &c.pin))!=EOF)
	{
		if(rAcc==c.acc_no)
		{
			flag=1;
			gotoxy(19,8);
			printf("Enter amount to be transferred: ");
			scanf("%f",&amt);
			if(amt<0)
			{
				border();
				gotoxy(19,10);
				printf("Amount can not be in negative");
				delay(2000);
				goto logout;
			}
			else
				if(amt>sBal)
				{
					border();
					gotoxy(19,10);
					printf("Insufficient Balance in your account.");
					delay(2000);
					goto logout;
				}
				else
				{
					c.bal=c.bal+amt;  //for receiver
					sBal=sBal-amt;	//for sender
					fprintf(f2,"%d %s %f %d %c",c.acc_no, c.name, c.bal, c.pin, '\n');
				}
		}
		else
		{
			fprintf(f2,"%d %s %f %d %c",c.acc_no, c.name, c.bal, c.pin, '\n');
		}
	}
	fclose(f2);
	fclose(f);

	if(flag==0)
	{
		border();
		gotoxy(19,8);
		printf("Receiver's Account does not exist");
		delay(2000);
	}
	else
	{
		border();
		//Copying temp_record.txt to record.txt and simultaneously checking and changing value
		//of senders balance
		f=fopen("record.txt","w");
		f2=fopen("temp_record.txt","r");
		if((f==NULL)||(f2==NULL))
		{
			border();
			gotoxy(19,13);
			printf("Database not found.");
			getch();
			goto logout;
		}
		while((fscanf(f2,"%d %[^0-9] %f %d",&c.acc_no, c.name, &c.bal, &c.pin))!=EOF)
		{
			if(sAcc==c.acc_no)
				fprintf(f,"%d %s %f %d %c",c.acc_no, c.name, sBal, c.pin, '\n');
			else
				fprintf(f,"%d %s %f %d %c",c.acc_no, c.name, c.bal, c.pin, '\n');
		}
		gotoxy(19,13);
		printf("Successfully transferred Rs.%2.2f from %d to %d.", amt, sAcc, rAcc);
		delay(2000);
	}
	fclose(f);
	fclose(f2);
	logout:
}